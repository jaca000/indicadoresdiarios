<!doctype html>
<html lang="pt-PT">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Monte do Pasto ¬∑ Painel Vivo</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">

<style>
*{box-sizing:border-box}
html,body{height:100%;margin:0}

:root{
  --g1:#6fa98c;
  --g2:#4f7f63;
  --b1:#7b6445;

  --glass:rgba(255,255,255,.20);
  --glass2:rgba(0,0,0,.12);
  --stroke:rgba(255,255,255,.25);

  --t1:#f4f6f3;
  --t2:rgba(244,246,243,.80);
  --t3:rgba(244,246,243,.60);

  --r1:18px;
  --r2:26px;
}

body{
  font-family:Inter,system-ui,Arial;
  color:var(--t1);
  overflow:hidden;
  background:
    radial-gradient(1200px 800px at 20% 10%, rgba(255,255,255,.20), transparent 60%),
    radial-gradient(900px 700px at 80% 20%, rgba(200,160,110,.18), transparent 60%),
    radial-gradient(1200px 900px at 60% 90%, rgba(140,220,180,.25), transparent 65%),
    linear-gradient(135deg,var(--g1),var(--g2) 55%,var(--b1));
}

/* ========= FX LAYER (sempre vis√≠vel) ========= */
#fx{
  position:fixed;
  inset:0;
  pointer-events:none;
  z-index:2;
}

.drop{
  position:absolute;
  width:2px;
  height:20px;
  background:rgba(220,245,255,.85);
  border-radius:999px;
  animation:fall linear infinite;
}
@keyframes fall{from{transform:translateY(-140px)}to{transform:translateY(110vh)}}

.fog{
  position:absolute;inset:-20%;
  background:
    radial-gradient(circle at 30% 50%, rgba(255,255,255,.16), transparent 55%),
    radial-gradient(circle at 70% 60%, rgba(255,255,255,.12), transparent 60%);
  animation:fogmove 120s linear infinite;
  opacity:.35;
}
@keyframes fogmove{from{transform:translateX(0)}to{transform:translateX(-14%)}}

.sunGlow{
  position:absolute;top:6%;right:10%;
  width:260px;height:260px;border-radius:50%;
  background:radial-gradient(circle,
    rgba(255,230,170,.85),
    rgba(255,210,150,.32),
    transparent 66%);
  animation:sunpulse 7s ease-in-out infinite;
  opacity:.75;
}
@keyframes sunpulse{0%,100%{transform:scale(.95)}50%{transform:scale(1.04)}}

/* ========= APP ========= */
.app{
  position:relative;
  z-index:3;
  height:100vh;
  display:grid;
  grid-template-rows:90px 1fr 48px;
}

/* ========= HEADER ========= */
header{
  padding:0 24px;
  display:flex;
  align-items:center;
  gap:14px;
  justify-content:space-between;
}

.header-left{
  display:flex;
  align-items:center;
  gap:14px;
  min-width:420px;
}

.logo{
  height:54px;
  filter:drop-shadow(0 10px 18px rgba(0,0,0,.18));
}

.now{
  display:flex;
  align-items:center;
  gap:12px;
  padding:10px 14px;
  border-radius:var(--r1);
  background:linear-gradient(180deg,var(--glass),var(--glass2));
  border:1px solid var(--stroke);
  backdrop-filter: blur(10px);
}

.now .temp{font-size:20px;font-weight:900;line-height:1}
.now .desc{font-size:13px;color:var(--t2);margin-top:2px}

.header-mid{
  flex:1;
  display:flex;
  align-items:center;
  justify-content:center;
  gap:14px;
  min-width:0;
}

.group{
  display:flex;
  align-items:center;
  gap:12px;
  padding:10px 14px;
  border-radius:var(--r1);
  background:linear-gradient(180deg,var(--glass),var(--glass2));
  border:1px solid var(--stroke);
  backdrop-filter: blur(10px);
  max-width:46vw;
  overflow:hidden;
}

.group-title{
  font-size:11px;
  text-transform:uppercase;
  color:var(--t2);
  letter-spacing:.7px;
  white-space:nowrap;
}

.pills{display:flex;gap:10px}

.pill{
  display:flex;
  align-items:center;
  gap:10px;
  padding:8px 12px;
  border-radius:16px;
  background:rgba(255,255,255,.22);
  border:1px solid rgba(255,255,255,.18);
  min-width:108px;
  animation:float 6s ease-in-out infinite;
}
.pill:nth-child(2){animation-delay:.6s}
.pill:nth-child(3){animation-delay:1.2s}
.pill:nth-child(4){animation-delay:1.8s}
@keyframes float{0%,100%{transform:translateY(0)}50%{transform:translateY(-3px)}}

.pill .big{font-size:15px;font-weight:900;line-height:1}
.pill .sub{font-size:11px;color:var(--t3);margin-top:2px}

.clock{
  flex:0 0 auto;
  flex-shrink:0;
  min-width:120px;
  text-align:right;
  font-size:28px;
  font-weight:900;
  line-height:1;
  text-shadow:0 10px 18px rgba(0,0,0,.18);
}

/* ========= Weather icons (CSS puro) ========= */
.icon{
  width:26px;height:26px;position:relative;flex:0 0 26px;
  filter:drop-shadow(0 8px 14px rgba(0,0,0,.18));
}
.icon.sun:before{
  content:"";position:absolute;inset:6px;border-radius:50%;
  background:radial-gradient(circle,#ffe6b4,#ffc36e);
}
.icon.cloud:before{
  content:"";position:absolute;left:3px;right:3px;bottom:7px;height:12px;
  background:#fff;border-radius:999px;opacity:.95;
}
.icon.cloud:after{
  content:"";position:absolute;left:6px;bottom:11px;width:12px;height:12px;
  background:#fff;border-radius:50%;
  box-shadow:10px -2px 0 #fff;
}
.icon.rain:before{
  content:"";position:absolute;left:3px;right:3px;bottom:11px;height:12px;
  background:#fff;border-radius:999px;
}
.icon.rain:after{
  content:"";position:absolute;left:9px;top:16px;width:10px;height:10px;
  background:
    radial-gradient(circle, rgba(170,230,255,.95) 2px, transparent 3px),
    radial-gradient(circle, rgba(170,230,255,.85) 2px, transparent 3px),
    radial-gradient(circle, rgba(170,230,255,.75) 2px, transparent 3px);
  background-position:0 0, 8px 2px, 4px 8px;
  background-size:10px 10px;
  background-repeat:no-repeat;
}

/* ========= KPIs ========= */
main{
  padding:22px 28px;

  display:grid;
  grid-template-columns:repeat(3, 1fr);
  grid-template-rows:repeat(3, 1fr);

  gap:22px;

  height:calc(100vh - 90px - 48px - 44px);
}

.card{
  background:linear-gradient(180deg,var(--glass),var(--glass2));
  border:1px solid var(--stroke);
  border-radius:var(--r2);
  padding:18px 20px;
  backdrop-filter: blur(10px);
  transition:opacity .4s, transform .4s;

  display:flex;
  flex-direction:column;
  justify-content:center;

  min-height:140px;
  height:100%;
}

.card.hidden{
  display:none;
}

.card h3{
  margin:0 0 10px;
  font-size:13px;
  text-transform:uppercase;
  color:var(--t2);
  letter-spacing:.6px;
}

.kpi{
  font-size: clamp(22px, 2.4vw, 40px);
  font-weight:900;
  line-height:1.15;
  word-break:break-word;
}
.kpi span{font-size:18px;color:var(--t2)}
.kpi-sub{margin-top:8px;font-size:18px;color:var(--t2)}
.thi-indicator{
  display:inline-block;
  width:18px;
  height:18px;
  border-radius:50%;
  margin-left:10px;
  box-shadow:0 0 12px rgba(0,0,0,.35);
}

.thi-ok{ background:#2ecc71; }
.thi-alerta{ background:#f1c40f; }
.thi-stress{ background:#e67e22; }
.thi-severo{ background:#e74c3c; }
.kpi-image img{
  width:100%;
  max-height:300px;
  object-fit:contain;
  border-radius:14px;
  background:rgba(0,0,0,.10);
}

/* ========= Footer ========= */
footer{
  padding:0 28px;
  display:flex;
  align-items:center;
  color:var(--t2);
  font-size:14px;
}

/* ========= ERVA ========= */
.footer-field{
  position:fixed;
  left:0; right:0; bottom:0;
  height:120px;
  z-index:4;
  pointer-events:none;
  background:
    linear-gradient(to top, rgba(0,0,0,.35), rgba(0,0,0,0) 70%),
    url("assets/grass.png") repeat-x bottom;
  background-size:auto 120px;
  transition:filter 2.5s ease;
}
.footer-field.dry{filter:saturate(.6) brightness(.9)}
.footer-field.normal{filter:saturate(1) brightness(1)}
.footer-field.wet{filter:saturate(1.35) brightness(1.05)}

/* ========= NEWS ========= */
.news-bar{
  position:fixed;
  left:0; right:0; bottom:0;
  height:68px;
  z-index:5;
  display:flex;
  align-items:center;
  overflow:hidden;
  background:linear-gradient(180deg, rgba(0,0,0,.40), rgba(0,0,0,.65));
  border-top:1px solid rgba(255,255,255,.28);
  backdrop-filter: blur(10px);
  pointer-events:none;
}
.news-track{
  display:inline-block;
  white-space:nowrap;
  padding-left:100%;
  animation:news-scroll 45s linear infinite;
  font-size:24px;
  font-weight:800;
  letter-spacing:.4px;
  color:var(--t1);
  text-shadow:0 10px 18px rgba(0,0,0,.35);
}
.news-item{display:inline-block;margin-right:100px}
@keyframes news-scroll{from{transform:translateX(0)}to{transform:translateX(-100%)}}

/* ===== ESTADOS DIN√ÇMICOS DO PAINEL ===== */
body.estado-normal{transition:filter 1.5s ease}
body.estado-chuva{filter:saturate(1.08) hue-rotate(-8deg);transition:filter 1.5s ease}
body.estado-seca{filter:brightness(.95) contrast(1.05);transition:filter 1.5s ease}

/* ===== CICLO DO DIA ===== */
body.periodo-manha{filter:brightness(1.05) saturate(1.05);transition:filter 2s ease}
body.periodo-dia{filter:brightness(1.1);transition:filter 2s ease}
body.periodo-por{filter:sepia(.18) saturate(1.2);transition:filter 2s ease}
body.periodo-noite{filter:brightness(.75) saturate(.85) hue-rotate(-8deg);transition:filter 2s ease}
</style>
</head>

<body>
<div id="fx"></div>

<div class="app">
  <header>
    <div class="header-left">
      <img class="logo" src="assets/logo-monte-do-pasto.png" alt="Monte do Pasto">
      <div class="now">
        <div id="nowIcon" class="icon cloud"></div>
        <div>
          <div class="temp" id="nowTemp">--¬∞C</div>
          <div class="desc" id="nowDesc">---</div>
        </div>
      </div>
    </div>

    <div class="header-mid">
      <div class="group">
        <div class="group-title">Pr√≥x. horas</div>
        <div class="pills" id="hours"></div>
      </div>
      <div class="group">
        <div class="group-title">Pr√≥x. dias</div>
        <div class="pills" id="days"></div>
      </div>
    </div>

    <div class="clock" id="clock">--:--</div>
  </header>

  <main id="kpis"></main>
  <footer>Informa√ß√£o interna ¬∑ Monte do Pasto</footer>
</div>

<div class="footer-field" aria-hidden="true"></div>

<div class="news-bar">
  <div class="news-track" id="newsTrack"></div>
</div>

<script>
/* ================= CONFIG ================= */
var LAT = 38.219, LON = -7.887;

var MAX_VISIBLE = 9;
var ROTATE_MS = 15000;

var SHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRcoOLTXvKf6K_4aejdyA7ZK6PObIzqyiLBBOPSehdSkKlxj9_ms0EqJOjT7u2lN11j5DaYIAkcqoy7/pub?output=csv";
var NEWS_SHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSgtnmWS6XFXm8V80ZzxQ1n4QwGxncyWqw4LnljjBu2kG5xWIRBoMLM_ya7cyg9B_Jyi9N2gqjSvVfS/pub?gid=0&single=true&output=csv";

var WEATHER_URL =
  "https://api.open-meteo.com/v1/forecast?latitude="+LAT+"&longitude="+LON+
  "&current_weather=true"+
  "&hourly=temperature_2m,relativehumidity_2m,precipitation,weathercode,windspeed_10m,shortwave_radiation"+
  "&daily=temperature_2m_max,temperature_2m_min,weathercode"+
  "&timezone=auto";

/* ================= ESTADO THI (mem√≥ria) ================= */
var LAST_THI = null;
var LAST_THI_LEVEL = null;
var LAST_RAIN_YTD = 0;

/* ================= CLOCK ================= */
function tick(){
  var d = new Date();
  var hh = ("0"+d.getHours()).slice(-2);
  var mm = ("0"+d.getMinutes()).slice(-2);
  document.getElementById("clock").textContent = hh+":"+mm;
}
tick();
setInterval(tick, 30000);

/* ===== CICLO DO DIA ===== */
function updateDayPeriod(){
  var hour = new Date().getHours();
  document.body.classList.remove("periodo-manha","periodo-dia","periodo-por","periodo-noite");
  if(hour >= 6 && hour < 11) document.body.classList.add("periodo-manha");
  else if(hour >= 11 && hour < 18) document.body.classList.add("periodo-dia");
  else if(hour >= 18 && hour < 21) document.body.classList.add("periodo-por");
  else document.body.classList.add("periodo-noite");
}

/* ================= OPEN-METEO CODES ================= */
function isRainCode(code){
  return (code===51||code===53||code===55||code===61||code===63||code===65||code===80||code===81||code===82||code===95||code===96||code===99);
}
function iconClass(code){
  if (isRainCode(code)) return "rain";
  if (code===0) return "sun";
  return "cloud";
}
function descFrom(code){
  if (isRainCode(code)) return "Chuva";
  if (code===0) return "Sol";
  return "Nublado";
}

/* ================= THI + IGCB ================= */

function calcTHI(tempC, rh){
  return tempC - ((0.55 - 0.0055 * rh) * (tempC - 14.5));
}

function calcIGCB(tempC, rh, wind, radiation, rain3d, rainYTD){

  let thi = calcTHI(tempC, rh);

  let stressHeat = Math.max(0, thi - 68) * 1.8;
  let stressSun = radiation * 0.02;
  let benefitWind = wind * 1.5;

  // üëâ Stress frio h√∫mido
let stressCold = 0;

// frio h√∫mido mais realista
if(tempC < 12 && rh > 85) stressCold = 12;
if(tempC < 8 && rh > 85) stressCold = 20;
if(tempC < 5 && rh > 85) stressCold = 30;

  // üëâ Stress lama N√ÉO linear + satura√ß√£o estrutural
  let stressMud = 0;

  if(rain3d > 60) stressMud = 35;
  else if(rain3d > 40) stressMud = 25;
  else if(rain3d > 20) stressMud = 15;
  else if(rain3d > 10) stressMud = 5;

if(rainYTD > 200) stressMud += 10;
if(rainYTD > 280) stressMud += 20;
if(rainYTD > 350) stressMud += 35;

  let score = 100 - (
    stressHeat +
    stressSun +
    stressMud +
    stressCold -
    benefitWind
  );

  return Math.max(0, Math.min(100, score));
}
function igcbLevel(igcb){

  if (igcb >= 85) return { txt:"Conforto √≥timo", class:"thi-ok" };
  if (igcb >= 70) return { txt:"Conforto aceit√°vel", class:"thi-alerta" };
  if (igcb >= 55) return { txt:"Stress ambiental", class:"thi-stress" };

  return { txt:"Stress cr√≠tico", class:"thi-severo" };
}

function upsertTHICard(valor, level){

  var grid = document.getElementById("kpis");
  if(!grid) return;

  var old = document.getElementById("thiCard");
  if(old) old.remove();

  var card = document.createElement("div");
  card.className = "card kpi-card";
  card.id = "thiCard";

  card.innerHTML =
    "<h3>üêÑ √çndice Global Conforto Bovino (IGCB)</h3>"+
    "<div class='kpi'>"+Number(valor).toFixed(1)+"</div>"+
    "<div class='kpi-sub'>"+
      level.txt+
      "<span class='thi-indicator "+level.class+"'></span>"+
    "</div>";

  var rainCard = document.getElementById("rainKpiCard");
  if(rainCard) grid.insertBefore(card, rainCard);
  else grid.prepend(card);

  refreshCardsAndRotation();
}
/* ================= FX HELPERS ================= */
function clearFX(){ document.getElementById("fx").innerHTML = ""; }
function addFog(){
  var f = document.createElement("div");
  f.className = "fog";
  document.getElementById("fx").appendChild(f);
}
function addSun(){
  var s = document.createElement("div");
  s.className = "sunGlow";
  document.getElementById("fx").appendChild(s);
}
function addRainDrops(count){
  var fx = document.getElementById("fx");
  for (var i=0;i<count;i++){
    var d = document.createElement("div");
    d.className = "drop";
    d.style.left = (Math.random()*100)+"%";
    d.style.animationDuration = (0.55 + Math.random()*1.2)+"s";
    d.style.opacity = (0.30 + Math.random()*0.55);
    d.style.height = (14 + Math.random()*20)+"px";
    fx.appendChild(d);
  }
}

function updatePanelState(code, temp, d){
  clearFX();
  addFog();

  document.body.classList.remove("estado-normal","estado-chuva","estado-seca");

  if (isRainCode(code)) document.body.classList.add("estado-chuva");
  else if (temp >= 32) document.body.classList.add("estado-seca");
  else document.body.classList.add("estado-normal");

  if (isRainCode(code)){
    var prec = 0;
    if (d.hourly && d.hourly.precipitation && d.hourly.precipitation[0] !== undefined){
      prec = Number(d.hourly.precipitation[0]) || 0;
    }
    var intensity = prec / 4;
    if (intensity < 0.20) intensity = 0.20;
    if (intensity > 1) intensity = 1;
    var drops = Math.floor(120 + intensity * 320);
    addRainDrops(drops);
  } else if (code === 0){
    addSun();
  }
}

/* ================= WEATHER ================= */
function updateWeather(){
  fetch(WEATHER_URL)
    .then(function(r){ return r.json(); })
    .then(function(d){
      var cw = d.current_weather || {};
      var temp = Math.round(cw.temperature || 0);
      var code = (cw.weathercode!==undefined ? cw.weathercode : 3);

      var rh = 0;
      if (d.hourly && d.hourly.relativehumidity_2m && d.hourly.relativehumidity_2m[0] !== undefined){
        rh = Number(d.hourly.relativehumidity_2m[0]) || 0;
      }

      document.getElementById("nowTemp").textContent = temp+"¬∞C";
      document.getElementById("nowDesc").textContent = descFrom(code);
      document.getElementById("nowIcon").className = "icon " + iconClass(code);

      var hoursEl = document.getElementById("hours");
      hoursEl.innerHTML = "";

      var hTemps = (d.hourly && d.hourly.temperature_2m) ? d.hourly.temperature_2m : [];
      var hCodes = (d.hourly && d.hourly.weathercode) ? d.hourly.weathercode : [];
      var hTimes = (d.hourly && d.hourly.time) ? d.hourly.time : [];

      for (var i=1;i<=4;i++){
        var t = Math.round(hTemps[i] || 0);
        var c = (hCodes[i]!==undefined ? hCodes[i] : 3);
        var hh = "--h";
        if (hTimes[i]){
          var dt = new Date(hTimes[i]);
          hh = ("0"+dt.getHours()).slice(-2) + "h";
        }
        hoursEl.innerHTML +=
          "<div class='pill'>"+
            "<div class='icon "+iconClass(c)+"'></div>"+
            "<div>"+
              "<div class='big'>"+t+"¬∞</div>"+
              "<div class='sub'>"+hh+"</div>"+
            "</div>"+
          "</div>";
      }

      var daysEl = document.getElementById("days");
      daysEl.innerHTML = "";

      var dMax = (d.daily && d.daily.temperature_2m_max) ? d.daily.temperature_2m_max : [];
      var dMin = (d.daily && d.daily.temperature_2m_min) ? d.daily.temperature_2m_min : [];
      var dCode = (d.daily && d.daily.weathercode) ? d.daily.weathercode : [];
      var dTime = (d.daily && d.daily.time) ? d.daily.time : [];

      var dias = ["Dom","Seg","Ter","Qua","Qui","Sex","S√°b"];

      for (var j=1;j<=4;j++){
        var tmax = Math.round(dMax[j] || 0);
        var tmin = Math.round(dMin[j] || 0);
        var cc = (dCode[j]!==undefined ? dCode[j] : 3);
        var wd = "---";
        if (dTime[j]){
          var dd = new Date(dTime[j]);
          wd = dias[dd.getDay()];
        }
        daysEl.innerHTML +=
          "<div class='pill'>"+
            "<div class='icon "+iconClass(cc)+"'></div>"+
            "<div>"+
              "<div class='big'>"+tmax+"¬∞/"+tmin+"¬∞</div>"+
              "<div class='sub'>"+wd+"</div>"+
            "</div>"+
          "</div>";
      }

      updatePanelState(code, temp, d);

      // THI: guarda e desenha j√° (mesmo que ainda n√£o exista rainKpiCard)
var thi = calcTHI(temp, rh);

// üëâ vento atual
var wind = 0;
if (d.hourly && d.hourly.windspeed_10m && d.hourly.windspeed_10m[0] !== undefined){
  wind = Number(d.hourly.windspeed_10m[0]) || 0;
}

// üëâ radia√ß√£o solar atual
var radiation = 0;
if (d.hourly && d.hourly.shortwave_radiation && d.hourly.shortwave_radiation[0] !== undefined){
  radiation = Number(d.hourly.shortwave_radiation[0]) || 0;
}

getRainLast3Days().then(function(rain3d){

  var rainYTD = LAST_RAIN_YTD || 0;

  var igcb = calcIGCB(temp, rh, wind, radiation, rain3d, rainYTD);

  var level = igcbLevel(igcb);   // üëà ESTAVA A FALTAR

  LAST_THI = igcb;
  LAST_THI_LEVEL = level;

  upsertTHICard(igcb, level);

})
.catch(function(){});

})  // üëà FECHA O .then(function(d){

.catch(function(){});

}   // üëà FECHA updateWeather

/* ================= CSV PARSER ================= */
function parseCSV(text){
  text = (text||"").replace(/\r/g,"").trim();
  if (!text) return [];
  var lines = text.split("\n");
  var headers = lines.shift().split(",");
  for (var i=0;i<headers.length;i++) headers[i] = (headers[i]||"").trim();
  var out = [];
  for (var l=0;l<lines.length;l++){
    if (!lines[l]) continue;
    var cols = lines[l].split(",");
    var row = {};
    for (var c=0;c<headers.length;c++){
      row[headers[c]] = (cols[c]||"").trim();
    }
    out.push(row);
  }
  return out;
}
function asBool(v){
  v = (v||"").toString().trim().toLowerCase();
  return (v==="true"||v==="1"||v==="sim"||v==="yes");
}
function asNum(v){
  if (v===undefined || v===null) return NaN;
  v = (""+v).trim().replace(",",".");
  var n = Number(v);
  return (isFinite(n) ? n : NaN);
}

/* ================= KPI ROTATION ================= */
var page = 0;
var cards = [];
var rotateTimer = null;

function refreshCardsAndRotation(){
  cards = Array.prototype.slice.call(document.querySelectorAll(".kpi-card"));
  startRotation();
}
function rotate(){
  if (!cards.length) return;
  var start = page * MAX_VISIBLE;
  var end = start + MAX_VISIBLE;

  for (var i=0;i<cards.length;i++){
    var show = (i>=start && i<end);
    if (show) cards[i].classList.remove("hidden");
    else cards[i].classList.add("hidden");
  }

  var totalPages = Math.ceil(cards.length / MAX_VISIBLE);
  page = (page + 1) % (totalPages || 1);
}
function startRotation(){
  if (rotateTimer) clearInterval(rotateTimer);
  page = 0;
  rotate();
  if (cards.length > MAX_VISIBLE){
    rotateTimer = setInterval(rotate, ROTATE_MS);
  }
}

/* ================= KPIs (Google Sheet) ================= */
function loadKPIs(){
  fetch(SHEET_URL, { cache: "no-store" })
    .then(function(r){ return r.text(); })
    .then(function(t){
      var rows = parseCSV(t).map(function(r){
        return {
          active: asBool(r.active),
          type: (r.type||"").trim().toLowerCase(),
          title: (r.title||"").trim(),
          value: (r.value||"").trim(),
          unit: (r.unit||"").trim(),
          imageUrl: (r.imageUrl||"").trim(),
          order: asNum(r.order)
        };
      }).filter(function(r){
        return r.active && r.type && r.title;
      });

      rows.sort(function(a,b){
        var ao = isFinite(a.order) ? a.order : 999999;
        var bo = isFinite(b.order) ? b.order : 999999;
        return ao - bo;
      });

      var grid = document.getElementById("kpis");
      grid.innerHTML = "";

      if (!rows.length){
        grid.innerHTML =
          "<div class='card kpi-card'>"+
            "<h3>Sem KPIs ativos</h3>"+
            "<div class='kpi-sub'>Liga KPIs na Google Sheet (active=TRUE).</div>"+
          "</div>";
      } else {
        for (var i=0;i<rows.length;i++){
          var r = rows[i];
          var body = "";

          if (r.type === "image"){
            body = r.imageUrl
              ? "<div class='kpi-image'><img src='"+r.imageUrl+"' alt=''></div>"
              : "<div class='kpi-sub'>Sem imageUrl</div>";
          } else if (r.type === "number"){
            body = "<div class='kpi'>"+(escapeHTML(r.value)||"--")+" <span>"+escapeHTML(r.unit||"")+"</span></div>";
          } else if (r.type === "text"){
            body = "<div class='kpi-sub'>"+escapeHTML(r.value||"")+"</div>";
          } else {
            body = "<div class='kpi-sub'>Tipo n√£o suportado: "+escapeHTML(r.type)+"</div>";
          }

          grid.innerHTML +=
            "<div class='card kpi-card'>"+
              "<h3>"+escapeHTML(r.title)+"</h3>"+
              body+
            "</div>";
        }
      }

      refreshCardsAndRotation();

      // Recria chuva e volta a ‚Äúencaixar‚Äù THI antes dela
      loadRainKPI();
    })
    .catch(function(){});
}

/* ================= NEWS ================= */
function loadNews(){
  if (!NEWS_SHEET_URL || NEWS_SHEET_URL.indexOf("http") !== 0){
    document.getElementById("newsTrack").innerHTML =
      "<span class='news-item'>Configura NEWS_SHEET_URL (CSV)</span>";
    return;
  }

  fetch(NEWS_SHEET_URL, { cache: "no-store" })
    .then(function(r){ return r.text(); })
    .then(function(t){
      var rows = parseCSV(t).map(function(r){
        return { active: asBool(r.active), order: asNum(r.order), text: (r.text||"").trim() };
      }).filter(function(r){ return r.active && r.text; });

      rows.sort(function(a,b){
        var ao = isFinite(a.order) ? a.order : 999999;
        var bo = isFinite(b.order) ? b.order : 999999;
        return ao - bo;
      });

      var track = document.getElementById("newsTrack");
      track.innerHTML = rows.length
        ? rows.map(function(x){ return "<span class='news-item'>"+escapeHTML(x.text)+"</span>"; }).join("")
        : "<span class='news-item'>Sem comunica√ß√µes ativas</span>";

      track.style.animation = "none";
      track.offsetHeight;
      track.style.animation = "";
    })
    .catch(function(){});
}

/* util p/ evitar injetar HTML por acidente */
function escapeHTML(s){
  return (s||"")
    .replace(/&/g,"&amp;")
    .replace(/</g,"&lt;")
    .replace(/>/g,"&gt;")
    .replace(/"/g,"&quot;")
    .replace(/'/g,"&#039;");
}

/* ================= ERVA COM VIDA ================= */
function updateGrassByRain(rainNow){
  var grass = document.querySelector(".footer-field");
  if (!grass) return;

  grass.classList.remove("dry","normal","wet");
  if (rainNow < 200) grass.classList.add("dry");
  else if (rainNow < 400) grass.classList.add("normal");
  else grass.classList.add("wet");
}

/* ================= CHUVA YTD ================= */
function buildRainURL(start, end){
  return "https://archive-api.open-meteo.com/v1/archive"
    + "?latitude=" + LAT
    + "&longitude=" + LON
    + "&start_date=" + start
    + "&end_date=" + end
    + "&daily=precipitation_sum"
    + "&timezone=auto";
}
function getRainSum(startDate, endDate){
  return fetch(buildRainURL(startDate, endDate))
    .then(function(r){ return r.json(); })
    .then(function(d){
      if (!d.daily || !d.daily.precipitation_sum) return 0;
      return d.daily.precipitation_sum.reduce(function(a,b){ return a + (b||0); }, 0);
    })
    .catch(function(){ return 0; });
}
function getRainLast3Days(){
  var end = new Date();
  var start = new Date();
  start.setDate(end.getDate() - 3);

  return getRainSum(
    start.toISOString().slice(0,10),
    end.toISOString().slice(0,10)
  );
}
function loadRainKPI(){
  var now = new Date();
  var year = now.getFullYear();
  var today = now.toISOString().slice(0,10);

  var startThisYear = year + "-01-01";
  var startLastYear = (year-1) + "-01-01";
  var sameDayLastYear = (year-1) + today.slice(4);

  Promise.all([
    getRainSum(startThisYear, today),
    getRainSum(startLastYear, sameDayLastYear)
  ]).then(function(values){
var rainNow = Math.round(values[0]);

LAST_RAIN_YTD = rainNow;

var rainLast = Math.round(values[1]);
var diff = rainNow - rainLast;

    updateGrassByRain(rainNow);

    var diffTxt =
      diff > 0 ? "(+"+diff+" L/m¬≤ vs "+(year-1)+")" :
      diff < 0 ? "("+diff+" L/m¬≤ vs "+(year-1)+")" :
      "(igual a "+(year-1)+")";

    var grid = document.getElementById("kpis");
    if (!grid) return;

    var old = document.getElementById("rainKpiCard");
    if (old && old.parentNode) old.parentNode.removeChild(old);

    var card = document.createElement("div");
    card.className = "card kpi-card";
    card.id = "rainKpiCard";
    card.innerHTML =
      "<h3>üåßÔ∏è Chuva acumulada (desde 1 Jan)</h3>" +
      "<div class='kpi'>"+rainNow+" <span>L/m¬≤</span></div>" +
      "<div class='kpi-sub'>"+diffTxt+"</div>";

    grid.prepend(card);

    // Agora que rain existe, volta a ‚Äúencaixar‚Äù THI antes dele (se j√° temos THI calculado)
    if (LAST_THI !== null && LAST_THI_LEVEL){
      upsertTHICard(LAST_THI, LAST_THI_LEVEL);
    } else {
      refreshCardsAndRotation();
    }
  });
}

/* ================= SCHEDULE ================= */
function scheduleHourly(fn){
  fn();
  var now = new Date();
  var msToNextHour =
    (60 - now.getMinutes())*60*1000 - now.getSeconds()*1000 - now.getMilliseconds();
  if (msToNextHour < 1000) msToNextHour = 1000;

  setTimeout(function(){
    fn();
    setInterval(fn, 5*60*1000);
  }, msToNextHour);
}

/* ================= INIT ================= */
updateDayPeriod();
setInterval(updateDayPeriod, 5*60*1000);

scheduleHourly(updateWeather);
scheduleHourly(loadKPIs);
scheduleHourly(loadNews);
</script>

<audio id="radioPlayer" preload="auto" autoplay loop muted>
  <source src="https://playerservices.streamtheworld.com/api/livestream-redirect/OBSERVADORAAC.aac" type="audio/aac">
</audio>

<script>
/* ================= RADIO AUTO INVIS√çVEL ================= */
(function(){
  const radio = document.getElementById("radioPlayer");
  if(!radio) return;

  let started = false;

  function startRadio(){
    if(started) return;
    started = true;

    radio.muted = true;
    radio.volume = 0;

    radio.play().then(() => {
      let v = 0;
      const fade = setInterval(() => {
        v += 0.02;
        if(v >= 0.25){
          radio.volume = 0.25;
          radio.muted = false;
          clearInterval(fade);
        } else {
          radio.volume = v;
        }
      }, 200);
    }).catch(() => {
      started = false;
    });
  }

  window.addEventListener("load", startRadio);
  document.addEventListener("click", startRadio);
  document.addEventListener("touchstart", startRadio);
})();
</script>

</body>
</html>
