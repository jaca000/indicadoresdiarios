<!doctype html>
<html lang="pt-PT">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Monte do Pasto · Painel Vivo</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap" rel="stylesheet">

  <style>
    * { box-sizing: border-box; }
    html, body { height: 100%; margin: 0; }
    body{
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color: var(--t1);
      overflow: hidden;
      background:
        radial-gradient(1200px 800px at 20% 10%, rgba(255,255,255,.20), transparent 60%),
        radial-gradient(900px 700px at 80% 20%, rgba(200,160,110,.18), transparent 60%),
        radial-gradient(1200px 900px at 60% 90%, rgba(140,220,180,.25), transparent 65%),
        linear-gradient(135deg, var(--g1), var(--g2) 55%, var(--b1));
    }

    :root{
      /* Base Monte do Pasto (verde + castanho) */
      --g1:#6fa98c;
      --g2:#4f7f63;
      --b1:#7b6445;

      --glass: rgba(255,255,255,.18);
      --glass2: rgba(0,0,0,.10);
      --stroke: rgba(255,255,255,.24);

      --t1:#f4f6f3;
      --t2: rgba(244,246,243,.82);
      --t3: rgba(244,246,243,.62);

      --r1: 18px;
      --r2: 26px;

      --headerMinH: 92px;
      --footerH: 48px;
    }

    /* =========================================================
       FX LAYER
    ========================================================= */
    #fx{
      position: fixed;
      inset: 0;
      pointer-events: none;
      z-index: 2;
      overflow: hidden;
    }

    .fog{
      position:absolute;
      inset:-20%;
      background:
        radial-gradient(circle at 30% 50%, rgba(255,255,255,.18), transparent 55%),
        radial-gradient(circle at 70% 60%, rgba(255,255,255,.12), transparent 60%),
        radial-gradient(circle at 55% 35%, rgba(255,255,255,.10), transparent 62%);
      opacity:.38;
      animation:fogMove 110s linear infinite;
      filter: blur(0.6px);
    }
    @keyframes fogMove{
      from{ transform: translateX(0); }
      to{ transform: translateX(-14%); }
    }

    .sunGlow{
      position:absolute;
      top: 5%;
      right: 10%;
      width: 280px;
      height: 280px;
      border-radius: 50%;
      background: radial-gradient(circle,
        rgba(255,230,170,.90),
        rgba(255,210,150,.30),
        transparent 66%);
      opacity: .78;
      animation: sunPulse 7s ease-in-out infinite;
    }
    @keyframes sunPulse{
      0%,100%{ transform: scale(.96); }
      50%{ transform: scale(1.04); }
    }

    .drop{
      position:absolute;
      width:2px;
      height:18px;
      background: rgba(220,245,255,.86);
      border-radius: 999px;
      animation-name: fall;
      animation-timing-function: linear;
      animation-iteration-count: infinite;
      will-change: transform;
    }
    @keyframes fall{
      from{ transform: translateY(-140px); }
      to{ transform: translateY(110vh); }
    }

    /* =========================================================
       APP LAYER
    ========================================================= */
    .app{
      position: relative;
      z-index: 3; /* acima dos FX */
      height: 100vh;
      display: grid;
      grid-template-rows: auto 1fr var(--footerH);
    }

    /* =========================================================
       HEADER (GRID) — não corta, faz scroll inteligente
    ========================================================= */
    header{
      padding: 14px 24px;
      min-height: var(--headerMinH);
      display: grid;
      grid-template-columns: auto 1fr auto;
      align-items: center;
      gap: 16px;
    }

    .header-left{
      display:flex;
      align-items:center;
      gap:14px;
      min-width: 360px;
    }

    .logo{
      height: 62px;
      filter: drop-shadow(0 10px 18px rgba(0,0,0,.18));
    }

    .glass{
      background: linear-gradient(180deg, var(--glass), var(--glass2));
      border: 1px solid var(--stroke);
      border-radius: var(--r1);
      backdrop-filter: blur(10px);
    }

    .now{
      display:flex;
      align-items:center;
      gap:12px;
      padding:10px 14px;
    }
    .now .temp{ font-size: 20px; font-weight: 900; line-height: 1; }
    .now .desc{ font-size: 13px; color: var(--t2); margin-top: 2px; }

    /* Centro: permite scroll horizontal se necessário (TVs variam) */
    .header-mid{
  display:flex;
  justify-content:center;
  align-items:center;
  gap: 12px;
  min-width: 0;
  max-width: calc(100vw - 520px); /* <<< ISTO É A CHAVE */
  overflow-x: auto;
}
    .header-mid::-webkit-scrollbar{ display:none; }

    .group{
      display:flex;
      align-items:center;
      gap:12px;
      padding:10px 14px;
      flex-shrink: 0;
      max-width: 920px;
    }

    .group-title{
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: .7px;
      color: var(--t2);
      white-space: nowrap;
    }

    .pills{
      display:flex;
      gap:10px;
      min-width: 0;
      overflow-x: auto;
      scrollbar-width: none;
      padding-bottom: 2px;
    }
    .pills::-webkit-scrollbar{ display:none; }

    .pill{
      display:flex;
      align-items:center;
      gap:10px;
      padding:8px 12px;
      border-radius: 16px;
      background: rgba(255,255,255,.22);
      border: 1px solid rgba(255,255,255,.18);
      min-width: 118px;
      animation: float 6s ease-in-out infinite;
      will-change: transform;
      flex-shrink: 0;
    }
    .pill:nth-child(2){ animation-delay: .6s; }
    .pill:nth-child(3){ animation-delay: 1.2s; }
    .pill:nth-child(4){ animation-delay: 1.8s; }
    @keyframes float{
      0%,100%{ transform: translateY(0); }
      50%{ transform: translateY(-3px); }
    }
    .pill .big{ font-size: 15px; font-weight: 900; line-height: 1; }
    .pill .sub{ font-size: 11px; color: var(--t3); margin-top: 2px; }

    .clock{
      min-width: 120px;
      text-align: right;
      font-size: 28px;
      font-weight: 900;
      white-space: nowrap;
      text-shadow: 0 10px 18px rgba(0,0,0,.18);
    }

    /* =========================================================
       ICONS (CSS puro + micro-vida)
    ========================================================= */
    .icon{
      width: 26px;
      height: 26px;
      position: relative;
      flex: 0 0 26px;
      filter: drop-shadow(0 8px 14px rgba(0,0,0,.18));
    }
    .icon.sun:before{
      content:"";
      position:absolute;
      inset:6px;
      border-radius:50%;
      background: radial-gradient(circle, #ffe6b4, #ffc36e);
      animation: sunSpin 10s linear infinite;
      transform-origin: center;
    }
    @keyframes sunSpin{
      from{ transform: rotate(0deg) scale(1); }
      50%{ transform: rotate(180deg) scale(1.02); }
      to{ transform: rotate(360deg) scale(1); }
    }

    .icon.cloud:before{
      content:"";
      position:absolute;
      left:3px; right:3px;
      bottom:7px;
      height:12px;
      background:#fff;
      border-radius:999px;
      opacity:.95;
    }
    .icon.cloud:after{
      content:"";
      position:absolute;
      left:6px;
      bottom:11px;
      width:12px;
      height:12px;
      background:#fff;
      border-radius:50%;
      box-shadow:10px -2px 0 #fff;
      opacity:.98;
      animation: cloudBob 4.8s ease-in-out infinite;
    }
    @keyframes cloudBob{
      0%,100%{ transform: translateY(0); }
      50%{ transform: translateY(-1.5px); }
    }

    .icon.rain:before{
      content:"";
      position:absolute;
      left:3px; right:3px;
      bottom:11px;
      height:12px;
      background:#fff;
      border-radius:999px;
      opacity:.95;
    }
    .icon.rain:after{
      content:"";
      position:absolute;
      left:9px;
      top:16px;
      width:10px;
      height:10px;
      background:
        radial-gradient(circle, rgba(170,230,255,.95) 2px, transparent 3px),
        radial-gradient(circle, rgba(170,230,255,.85) 2px, transparent 3px),
        radial-gradient(circle, rgba(170,230,255,.75) 2px, transparent 3px);
      background-position:0 0, 8px 2px, 4px 8px;
      background-size:10px 10px;
      background-repeat:no-repeat;
      opacity:.95;
      animation: rainIcon 0.9s linear infinite;
    }
    @keyframes rainIcon{
      from{ transform: translateY(0); opacity:.95; }
      to{ transform: translateY(2px); opacity:.75; }
    }

    /* =========================================================
       MAIN / KPIs — adaptam ao conteúdo (sem “janelas gigantes”)
    ========================================================= */
    main{
      padding: 22px 28px;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: 22px;
      align-items: start;
      overflow: hidden;
    }

    .card{
      background: linear-gradient(180deg, var(--glass), var(--glass2));
      border: 1px solid var(--stroke);
      border-radius: var(--r2);
      padding: clamp(14px, 1.6vw, 18px) clamp(16px, 1.8vw, 20px);
      backdrop-filter: blur(10px);
      align-self: start;
      max-width: 560px;          /* impede “tapetes” */
      width: 100%;
      transition: opacity .35s, transform .35s;
    }

    .card.hidden{
      opacity: 0;
      transform: translateY(10px);
      pointer-events: none;
    }

    .card h3{
      margin: 0 0 10px;
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: .6px;
      color: var(--t2);
    }

    .kpi{
      font-size: clamp(40px, 3.8vw, 54px);
      font-weight: 900;
      line-height: 1;
    }
    .kpi span{
      font-size: 18px;
      color: var(--t2);
      font-weight: 700;
    }
    .kpi-sub{
      margin-top: 8px;
      font-size: clamp(14px, 1.6vw, 18px);
      color: var(--t2);
    }

    .kpi-image img{
      width: 100%;
      max-height: clamp(220px, 24vh, 320px);
      object-fit: contain;
      border-radius: 14px;
      background: rgba(0,0,0,.08);
    }

    /* KPI do sistema (fixo) — visual igual aos outros */
    .system-kpi{ }

    /* =========================================================
       FOOTER
    ========================================================= */
    footer{
      padding: 0 28px;
      display:flex;
      align-items:center;
      color: var(--t2);
      font-size: 14px;
      opacity: .9;
    }
  </style>
</head>

<body>

  <div id="fx"></div>

  <div class="app">
    <header>
      <div class="header-left">
        <img class="logo" src="assets/logo-monte-do-pasto.png" alt="Monte do Pasto">

        <div class="now glass">
          <div id="nowIcon" class="icon cloud" aria-hidden="true"></div>
          <div>
            <div id="nowTemp" class="temp">--°C</div>
            <div id="nowDesc" class="desc">---</div>
          </div>
        </div>
      </div>

      <div class="header-mid">
        <div class="group glass">
          <div class="group-title">Próx. horas</div>
          <div id="hours" class="pills"></div>
        </div>

        <div class="group glass">
          <div class="group-title">Próx. dias</div>
          <div id="days" class="pills"></div>
        </div>
      </div>

      <div id="clock" class="clock">--:--</div>
    </header>

    <main id="kpis"></main>
    <footer>Informação interna · Monte do Pasto</footer>
  </div>

<script>
/* =========================================================
   CONFIG
========================================================= */
var LAT = 38.219;   // Cuba (aprox.)
var LON = -7.887;

var MAX_VISIBLE = 6;       // KPIs da Sheet por página
var ROTATE_MS  = 15000;    // rotação KPIs da Sheet

var SHEET_URL =
  "https://docs.google.com/spreadsheets/d/e/2PACX-1vRcoOLTXvKf6K_4aejdyA7ZK6PObIzqyiLBBOPSehdSkKlxj9_ms0EqJOjT7u2lN11j5DaYIAkcqoy7/pub?output=csv";

var FORECAST_URL =
  "https://api.open-meteo.com/v1/forecast?latitude=" + LAT + "&longitude=" + LON +
  "&current_weather=true" +
  "&hourly=temperature_2m,precipitation,weathercode" +
  "&daily=temperature_2m_max,temperature_2m_min,weathercode" +
  "&timezone=auto";

var ARCHIVE_BASE =
  "https://archive-api.open-meteo.com/v1/archive?latitude=" + LAT + "&longitude=" + LON +
  "&daily=precipitation_sum&timezone=auto";

/* =========================================================
   ELEMENTOS
========================================================= */
var fx = document.getElementById("fx");
var nowIcon = document.getElementById("nowIcon");
var nowTemp = document.getElementById("nowTemp");
var nowDesc = document.getElementById("nowDesc");
var hoursEl = document.getElementById("hours");
var daysEl  = document.getElementById("days");
var kpisEl  = document.getElementById("kpis");
var clockEl = document.getElementById("clock");

/* =========================================================
   CLOCK
========================================================= */
function tickClock(){
  var d = new Date();
  var hh = ("0"+d.getHours()).slice(-2);
  var mm = ("0"+d.getMinutes()).slice(-2);
  clockEl.textContent = hh + ":" + mm;
}
tickClock();
setInterval(tickClock, 30000);

/* =========================================================
   HELPERS
========================================================= */
function pad2(n){ return (n < 10 ? "0"+n : ""+n); }
function fmtDate(d){
  return d.getFullYear() + "-" + pad2(d.getMonth()+1) + "-" + pad2(d.getDate());
}
function startOfYear(year){ return new Date(year, 0, 1); }
function addDays(date, days){
  var d = new Date(date.getTime());
  d.setDate(d.getDate() + days);
  return d;
}
function clamp(n, min, max){ return Math.max(min, Math.min(max, n)); }

function asBool(v){
  v = (v||"").toString().trim().toLowerCase();
  return (v==="true" || v==="1" || v==="sim" || v==="yes");
}
function asNum(v){
  if (v===undefined || v===null) return NaN;
  v = (""+v).trim().replace(",",".");
  var n = Number(v);
  return (isFinite(n) ? n : NaN);
}

/* CSV robusto (suporta aspas e vírgulas em campos) */
function parseCSV(text){
  text = (text || "").replace(/\r/g, "");
  if (!text.trim()) return [];
  var rows = [];
  var row = [];
  var cur = "";
  var inQuotes = false;

  for (var i=0;i<text.length;i++){
    var ch = text[i];
    if (ch === '"'){
      if (inQuotes && text[i+1] === '"'){
        cur += '"'; i++;
      } else {
        inQuotes = !inQuotes;
      }
    } else if (ch === ',' && !inQuotes){
      row.push(cur); cur = "";
    } else if (ch === '\n' && !inQuotes){
      row.push(cur); rows.push(row); row = []; cur = "";
    } else {
      cur += ch;
    }
  }
  row.push(cur);
  rows.push(row);

  var headers = rows.shift().map(function(h){ return (h||"").trim(); });
  var out = [];
  for (var r=0;r<rows.length;r++){
    if (rows[r].length === 1 && !rows[r][0].trim()) continue;
    var obj = {};
    for (var c=0;c<headers.length;c++){
      obj[headers[c]] = (rows[r][c] || "").trim();
    }
    out.push(obj);
  }
  return out;
}

/* =========================================================
   WEATHER CODES (Open-Meteo)
========================================================= */
function isRainCode(code){
  return (code===51||code===53||code===55||code===61||code===63||code===65||code===80||code===81||code===82||code===95||code===96||code===99);
}
function iconClass(code){
  if (isRainCode(code)) return "rain";
  if (code === 0) return "sun";
  return "cloud";
}
function descFrom(code){
  if (isRainCode(code)) return "Chuva";
  if (code === 0) return "Sol";
  return "Nublado";
}

/* =========================================================
   THEME MOOD (verde muda com o tempo)
========================================================= */
function setMood(code, precip){
  // precip em mm/h (0..)
  // Mantém sempre verde/castanho, mas “muda o mood”
  var g1 = "#6fa98c", g2 = "#4f7f63", b1 = "#7b6445";

  if (isRainCode(code)){
    // mais húmido/escuro quanto mais precip
    var k = clamp((precip || 0) / 6, 0, 1); // 0..1
    g1 = mixHex("#7ab79a", "#4f7f63", k);
    g2 = mixHex("#5a8f73", "#3f6a53", k);
    b1 = mixHex("#7b6445", "#6a553a", k);
  } else if (code === 0){
    // sol mais vivo
    g1 = "#78b89a";
    g2 = "#4f8a6c";
    b1 = "#806443";
  } else {
    // nublado: mais suave
    g1 = "#73ad90";
    g2 = "#4b7a60";
    b1 = "#7a6344";
  }

  document.documentElement.style.setProperty("--g1", g1);
  document.documentElement.style.setProperty("--g2", g2);
  document.documentElement.style.setProperty("--b1", b1);
}

// mistura simples de hex
function hexToRgb(h){
  h = h.replace("#","");
  return {
    r: parseInt(h.slice(0,2),16),
    g: parseInt(h.slice(2,4),16),
    b: parseInt(h.slice(4,6),16)
  };
}
function rgbToHex(r,g,b){
  function c(n){ var s=n.toString(16); return s.length===1?("0"+s):s; }
  return "#"+c(r)+c(g)+c(b);
}
function mixHex(a,b,t){
  var A=hexToRgb(a), B=hexToRgb(b);
  var r = Math.round(A.r + (B.r-A.r)*t);
  var g = Math.round(A.g + (B.g-A.g)*t);
  var bb= Math.round(A.b + (B.b-A.b)*t);
  return rgbToHex(r,g,bb);
}

/* =========================================================
   FX ENGINE
========================================================= */
function clearFX(){ fx.innerHTML = ""; }
function addFog(){
  var f = document.createElement("div");
  f.className = "fog";
  fx.appendChild(f);
}
function addSun(){
  var s = document.createElement("div");
  s.className = "sunGlow";
  fx.appendChild(s);
}
function addRainDrops(count){
  for (var i=0;i<count;i++){
    var d = document.createElement("div");
    d.className = "drop";
    d.style.left = (Math.random()*100) + "%";
    d.style.opacity = (0.25 + Math.random()*0.60);
    d.style.height = (14 + Math.random()*22) + "px";
    d.style.animationDuration = (0.55 + Math.random()*1.25) + "s";
    fx.appendChild(d);
  }
}

function applyFX(code, precipNow){
  // fog sempre (dá “vida” mesmo sem chuva)
  clearFX();
  addFog();

  if (isRainCode(code)){
    var intensity = clamp((precipNow || 0) / 6, 0.18, 1); // 0.18..1
    var drops = Math.floor(140 + intensity * 520);        // 140..660
    addRainDrops(drops);
  } else if (code === 0){
    addSun();
  }
}

/* =========================================================
   WEATHER (tempo real + widgets + FX + mood)
========================================================= */
async function updateWeather(){
  try{
    var r = await fetch(FORECAST_URL, { cache: "no-store" });
    var d = await r.json();

    var cw = d.current_weather || {};
    var temp = Math.round(cw.temperature || 0);
    var code = (cw.weathercode!==undefined ? cw.weathercode : 3);

    // precipitação "agora": usar hourly[0] (mm/h) se existir
    var precipNow = 0;
    if (d.hourly && d.hourly.precipitation && d.hourly.precipitation[0]!==undefined){
      precipNow = Number(d.hourly.precipitation[0]) || 0;
    }

    // header now
    nowTemp.textContent = temp + "°C";
    nowDesc.textContent = descFrom(code);
    nowIcon.className = "icon " + iconClass(code);

    // mood + FX
    setMood(code, precipNow);
    applyFX(code, precipNow);

    // próximas 4 horas
    hoursEl.innerHTML = "";
    var hTemps = (d.hourly && d.hourly.temperature_2m) ? d.hourly.temperature_2m : [];
    var hCodes = (d.hourly && d.hourly.weathercode) ? d.hourly.weathercode : [];
    var hTimes = (d.hourly && d.hourly.time) ? d.hourly.time : [];

    for (var i=1;i<=4;i++){
      var t = Math.round(hTemps[i] || 0);
      var c = (hCodes[i]!==undefined ? hCodes[i] : 3);
      var hh = "--h";
      if (hTimes[i]){
        var dt = new Date(hTimes[i]);
        hh = pad2(dt.getHours()) + "h";
      }
      hoursEl.innerHTML +=
        "<div class='pill'>" +
          "<div class='icon " + iconClass(c) + "'></div>" +
          "<div>" +
            "<div class='big'>" + t + "°</div>" +
            "<div class='sub'>" + hh + "</div>" +
          "</div>" +
        "</div>";
    }

    // próximos 4 dias
    daysEl.innerHTML = "";
    var dMax = (d.daily && d.daily.temperature_2m_max) ? d.daily.temperature_2m_max : [];
    var dMin = (d.daily && d.daily.temperature_2m_min) ? d.daily.temperature_2m_min : [];
    var dCode = (d.daily && d.daily.weathercode) ? d.daily.weathercode : [];
    var dTime = (d.daily && d.daily.time) ? d.daily.time : [];

    var dias = ["Dom","Seg","Ter","Qua","Qui","Sex","Sáb"];
    for (var j=1;j<=4;j++){
      var tmax = Math.round(dMax[j] || 0);
      var tmin = Math.round(dMin[j] || 0);
      var cc = (dCode[j]!==undefined ? dCode[j] : 3);

      var wd = "---";
      if (dTime[j]){
        var dd = new Date(dTime[j]);
        wd = dias[dd.getDay()];
      }

      daysEl.innerHTML +=
        "<div class='pill'>" +
          "<div class='icon " + iconClass(cc) + "'></div>" +
          "<div>" +
            "<div class='big'>" + tmax + "°/" + tmin + "°</div>" +
            "<div class='sub'>" + wd + "</div>" +
          "</div>" +
        "</div>";
    }

    return { ok:true };
  } catch(e){
    // mantém algo visível mesmo sem rede
    nowDesc.textContent = "Sem ligação";
    return { ok:false, err:e };
  }
}

/* =========================================================
   KPI FIXO: chuva acumulada (Jan 1 -> ontem) vs ano anterior
   - mm = L/m²
========================================================= */
var rainKpiHtmlCache = "";

function sumArray(arr){
  var s = 0;
  for (var i=0;i<arr.length;i++) s += (Number(arr[i]) || 0);
  return s;
}

async function fetchArchiveRainSum(startDateStr, endDateStr){
  var url = ARCHIVE_BASE + "&start_date=" + startDateStr + "&end_date=" + endDateStr;
  var r = await fetch(url, { cache: "no-store" });
  var d = await r.json();
  if (d && d.daily && d.daily.precipitation_sum) return sumArray(d.daily.precipitation_sum);
  return null;
}

async function updateRainKPI(){
  try{
    var today = new Date();
    var endNow = addDays(today, -1);       // ontem (dias completos)
    var yearNow = today.getFullYear();
    var yearPrev = yearNow - 1;

    // 1 de janeiro: ontem cai no ano anterior -> 0
    if (endNow.getFullYear() !== yearNow){
      rainKpiHtmlCache =
        "<div class='card system-kpi' id='kpiRainFixed'>" +
          "<h3>Chuva acumulada (desde 1 de janeiro)</h3>" +
          "<div class='kpi'>0 <span>L/m²</span></div>" +
          "<div class='kpi-sub'>+0 L/m² vs " + yearPrev + "</div>" +
        "</div>";
      return true;
    }

    var startNowStr = fmtDate(startOfYear(yearNow));
    var endNowStr   = fmtDate(endNow);

    // mesmo dia/mês de ontem no ano anterior
    var endPrev = new Date(yearPrev, endNow.getMonth(), endNow.getDate());
    var startPrevStr = fmtDate(startOfYear(yearPrev));
    var endPrevStr   = fmtDate(endPrev);

    var sumNow  = await fetchArchiveRainSum(startNowStr, endNowStr);
    var sumPrev = await fetchArchiveRainSum(startPrevStr, endPrevStr);

    if (sumNow === null || sumPrev === null){
      rainKpiHtmlCache =
        "<div class='card system-kpi' id='kpiRainFixed'>" +
          "<h3>Chuva acumulada (desde 1 de janeiro)</h3>" +
          "<div class='kpi'>-- <span>L/m²</span></div>" +
          "<div class='kpi-sub'>Sem dados neste momento</div>" +
        "</div>";
      return false;
    }

    var nowRounded = Math.round(sumNow);
    var prevRounded = Math.round(sumPrev);
    var diff = nowRounded - prevRounded;
    var sign = diff >= 0 ? "+" : "−";

    rainKpiHtmlCache =
      "<div class='card system-kpi' id='kpiRainFixed'>" +
        "<h3>Chuva acumulada (desde 1 de janeiro)</h3>" +
        "<div class='kpi'>" + nowRounded + " <span>L/m²</span></div>" +
        "<div class='kpi-sub'>" + sign + Math.abs(diff) + " L/m² vs " + yearPrev + "</div>" +
      "</div>";

    return true;
  } catch(e){
    rainKpiHtmlCache =
      "<div class='card system-kpi' id='kpiRainFixed'>" +
        "<h3>Chuva acumulada (desde 1 de janeiro)</h3>" +
        "<div class='kpi'>-- <span>L/m²</span></div>" +
        "<div class='kpi-sub'>Sem ligação ao histórico</div>" +
      "</div>";
    return false;
  }
}

/* =========================================================
   KPIs da SHEET + rotação
   Campos recomendados na sheet (colunas):
   id, active, type, title, value, unit, imageUrl, order, extra
   type: number | text | image
========================================================= */
var page = 0;
var cards = [];
var rotateTimer = null;

function rotateSheetKPIs(){
  if (!cards.length) return;

  var start = page * MAX_VISIBLE;
  var end = start + MAX_VISIBLE;

  for (var i=0;i<cards.length;i++){
    var show = (i >= start && i < end);
    if (show) cards[i].classList.remove("hidden");
    else cards[i].classList.add("hidden");
  }

  var totalPages = Math.ceil(cards.length / MAX_VISIBLE);
  page = (page + 1) % (totalPages || 1);
}

function startRotation(){
  if (rotateTimer) clearInterval(rotateTimer);
  page = 0;
  rotateSheetKPIs();

  if (cards.length > MAX_VISIBLE){
    rotateTimer = setInterval(rotateSheetKPIs, ROTATE_MS);
  }
}

async function loadKPIsFromSheet(){
  try{
    var r = await fetch(SHEET_URL, { cache: "no-store" });
    var csvText = await r.text();

    var rows = parseCSV(csvText)
      .map(function(rr){
        return {
          id: (rr.id||"").trim(),
          active: asBool(rr.active),
          type: (rr.type||"").trim().toLowerCase(),
          title: (rr.title||"").trim(),
          value: (rr.value||"").trim(),
          unit: (rr.unit||"").trim(),
          imageUrl: (rr.imageUrl||"").trim(),
          order: asNum(rr.order),
          extra: (rr.extra||"").trim()
        };
      })
      .filter(function(x){
        return x.active && x.type && x.title;
      });

    rows.sort(function(a,b){
      var ao = isFinite(a.order) ? a.order : 999999;
      var bo = isFinite(b.order) ? b.order : 999999;
      return ao - bo;
    });

    // Render final: KPI fixo + KPIs da sheet
    kpisEl.innerHTML = (rainKpiHtmlCache || "");

    if (!rows.length){
      kpisEl.innerHTML +=
        "<div class='card sheet-kpi'>" +
          "<h3>Sem KPIs ativos (Sheet)</h3>" +
          "<div class='kpi-sub'>Liga KPIs na Google Sheet (active=TRUE).</div>" +
        "</div>";
    } else {
      for (var i=0;i<rows.length;i++){
        var it = rows[i];
        var body = "";

        if (it.type === "image"){
          body = it.imageUrl
            ? "<div class='kpi-image'><img src='" + it.imageUrl + "' alt=''></div>"
            : "<div class='kpi-sub'>Sem imageUrl</div>";
        } else if (it.type === "number"){
          body = "<div class='kpi'>" + (it.value || "--") + " <span>" + (it.unit || "") + "</span></div>";
        } else if (it.type === "text"){
          body = "<div class='kpi-sub'>" + (it.value || "") + "</div>";
        } else {
          body = "<div class='kpi-sub'>Tipo não suportado: " + it.type + "</div>";
        }

        kpisEl.innerHTML +=
          "<div class='card sheet-kpi'>" +
            "<h3>" + it.title + "</h3>" +
            body +
          "</div>";
      }
    }

    cards = Array.prototype.slice.call(document.querySelectorAll(".sheet-kpi"));
    startRotation();
    return true;
  } catch(e){
    kpisEl.innerHTML = (rainKpiHtmlCache || "") +
      "<div class='card sheet-kpi'>" +
        "<h3>Erro a carregar KPIs (Sheet)</h3>" +
        "<div class='kpi-sub'>Sem ligação à Google Sheet neste momento.</div>" +
      "</div>";

    cards = Array.prototype.slice.call(document.querySelectorAll(".sheet-kpi"));
    startRotation();
    return false;
  }
}

/* =========================================================
   REFRESH HORÁRIO (alinhado à hora cheia)
========================================================= */
function scheduleHourly(fn){
  fn();

  var now = new Date();
  var msToNextHour =
    (60 - now.getMinutes()) * 60 * 1000 -
    now.getSeconds() * 1000 -
    now.getMilliseconds();

  if (msToNextHour < 1000) msToNextHour = 1000;

  setTimeout(function(){
    fn();
    setInterval(fn, 60*60*1000);
  }, msToNextHour);
}

/* =========================================================
   REFRESH GLOBAL (ordem importa)
========================================================= */
async function refreshAll(){
  await updateWeather();
  await updateRainKPI();
  await loadKPIsFromSheet();
}

/* =========================================================
   INIT
========================================================= */
refreshAll();
scheduleHourly(refreshAll);

</script>
</body>
</html>
