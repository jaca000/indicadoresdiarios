<!doctype html>
<html lang="pt-PT">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Monte do Pasto · Painel Vivo</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">

<style>
/* ================= RESET ================= */
*{box-sizing:border-box}
html,body{height:100%}

/* ================= VARIÁVEIS (MOOD) ================= */
:root{
  --g1:#6fa98c;
  --g2:#4f7f63;
  --b1:#7b6445;

  --glass:rgba(255,255,255,.18);
  --glass2:rgba(0,0,0,.10);
  --stroke:rgba(255,255,255,.22);

  --t1:#f4f6f3;
  --t2:rgba(244,246,243,.78);
  --t3:rgba(244,246,243,.60);

  --good:#7fd18c;
  --bad:#d1b27f;

  --radius-1:18px;
  --radius-2:26px;
}

/* ================= BODY ================= */
body{
  margin:0;
  font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial;
  color:var(--t1);
  overflow:hidden;
  transition:background 12s ease;

  background:
    radial-gradient(1200px 800px at 20% 10%, rgba(255,255,255,.20), transparent 60%),
    radial-gradient(900px 700px at 80% 20%, rgba(200,160,110,.18), transparent 60%),
    radial-gradient(1200px 900px at 60% 90%, rgba(140,220,180,.25), transparent 65%),
    linear-gradient(135deg,var(--g1),var(--g2) 55%,var(--b1));
}

/* ================= FX (tempo) ================= */
#fx{position:fixed;inset:0;pointer-events:none;z-index:0}

/* chuva */
.drop{
  position:absolute;width:2px;height:18px;
  background:rgba(230,245,255,.60);
  border-radius:999px;
  animation:fall linear infinite;
}
@keyframes fall{
  from{transform:translateY(-120px)}
  to{transform:translateY(110vh)}
}

/* neve (opcional futuro) */
.flake{
  position:absolute;width:4px;height:4px;border-radius:50%;
  background:rgba(245,252,255,.9);
  animation:snow linear infinite;
}
@keyframes snow{
  from{transform:translateY(-40px)}
  to{transform:translateY(110vh)}
}

/* nevoeiro */
.fog{
  position:absolute;inset:-20%;
  background:
    radial-gradient(circle at 30% 50%, rgba(255,255,255,.18), transparent 55%),
    radial-gradient(circle at 70% 60%, rgba(255,255,255,.14), transparent 60%);
  animation:fogmove 120s linear infinite;
}
@keyframes fogmove{
  from{transform:translateX(0)}
  to{transform:translateX(-14%)}
}

/* sol */
.sunGlow{
  position:absolute;top:8%;right:12%;
  width:320px;height:320px;border-radius:50%;
  background:radial-gradient(circle,
    rgba(255,230,170,.90),
    rgba(255,210,150,.35),
    transparent 66%);
  animation:sunpulse 7s ease-in-out infinite;
}
@keyframes sunpulse{
  0%,100%{transform:scale(.95);opacity:.8}
  50%{transform:scale(1.03);opacity:1}
}

/* ================= APP LAYOUT ================= */
.app{
  position:relative;
  z-index:1;
  height:100vh;
  display:grid;
  grid-template-rows:96px 1fr 48px;
}

/* ================= HEADER ================= */
header{
  padding:0 28px;
  display:flex;
  align-items:center;
  gap:18px;
}

.header-left{
  display:flex;
  align-items:center;
  gap:16px;
  min-width:380px;
}

.logo{height:48px; filter:drop-shadow(0 8px 14px rgba(0,0,0,.22));}

.now{
  display:flex;gap:10px;align-items:center;
  padding:10px 14px;border-radius:var(--radius-1);
  background:linear-gradient(180deg,var(--glass),var(--glass2));
  border:1px solid var(--stroke);
  backdrop-filter: blur(10px);
}
.now .temp{font-size:20px;font-weight:800}
.now .desc{font-size:14px;color:var(--t2)}

.header-mid{
  flex:1;
  display:flex;
  justify-content:center;
  gap:14px;
}

.group{
  display:flex;
  align-items:center;
  gap:10px;
  padding:10px 14px;
  border-radius:var(--radius-1);
  background:linear-gradient(180deg,rgba(255,255,255,.16),rgba(0,0,0,.10));
  border:1px solid var(--stroke);
  backdrop-filter: blur(10px);
}

.group .title{
  font-size:12px;
  text-transform:uppercase;
  color:var(--t2);
  letter-spacing:.8px;
}

.pills{display:flex;gap:10px}

.pill{
  display:flex;gap:8px;align-items:center;
  padding:8px 10px;border-radius:14px;
  background:rgba(255,255,255,.22);
  border:1px solid rgba(255,255,255,.18);
  min-width:100px;
}

.small{font-size:14px;font-weight:800}
.sub{font-size:12px;color:var(--t3)}

.clock{
  min-width:90px;
  text-align:right;
  font-size:30px;
  font-weight:800;
  text-shadow: 0 10px 18px rgba(0,0,0,.18);
}

/* ================= MAIN (KPIs) ================= */
main{
  padding:22px 28px;
  display:grid;
  grid-template-columns:repeat(3,1fr); /* 3 colunas */
  gap:22px;
  align-items:start;
}

.card{
  align-self:start;
  height:auto;
  background:linear-gradient(180deg,rgba(255,255,255,.18),rgba(0,0,0,.10));
  border:1px solid var(--stroke);
  border-radius:var(--radius-2);
  padding:18px 20px;
  backdrop-filter: blur(10px);
  transition:opacity .45s ease, transform .45s ease;
}

.card.hidden{
  opacity:0;
  transform:translateY(10px);
  pointer-events:none;
}

.card h3{
  margin:0 0 10px;
  font-size:13px;
  text-transform:uppercase;
  color:var(--t2);
  letter-spacing:.6px;
}

.kpi{
  font-size:56px;
  font-weight:900;
  letter-spacing:-.5px;
  line-height:1.0;
}
.kpi span{font-size:18px;color:var(--t2); font-weight:700}

.kpi-sub{
  margin-top:8px;
  font-size:18px;
}
.kpi-sub.good{color:var(--good)}
.kpi-sub.bad{color:var(--bad)}
.kpi-sub.neutral{color:var(--t2)}

.kpi-image{
  margin-top:10px;
}
.kpi-image img{
  width:100%;
  max-height:260px;
  object-fit:contain;
  border-radius:16px;
  background:rgba(0,0,0,.10);
}

/* ================= FOOTER ================= */
footer{
  padding:0 28px;
  display:flex;
  align-items:center;
  color:var(--t2);
  font-size:14px;
}

/* ================= ÍCONES TEMPO ================= */
.icon{width:26px;height:26px;position:relative;flex:0 0 26px}

.icon.sun::before{
  content:""; position:absolute; inset:5px; border-radius:50%;
  background:radial-gradient(circle,#ffe6b4,#ffc36e);
  animation:sunMini 4s ease-in-out infinite;
}
@keyframes sunMini{0%,100%{transform:scale(.9)}50%{transform:scale(1.05)}}

.icon.cloud::before{
  content:""; position:absolute; left:3px; right:3px; bottom:6px; height:12px;
  background:#fff; border-radius:12px; opacity:.9;
}
.icon.cloud::after{
  content:""; position:absolute; left:6px; bottom:10px; width:12px; height:12px;
  background:#fff; border-radius:50%;
  box-shadow:10px -2px 0 #fff;
  opacity:.95;
}

.icon.rain::before{
  content:""; position:absolute; left:3px; right:3px; bottom:10px; height:10px;
  background:#fff; border-radius:12px; opacity:.92;
}
.icon.rain::after{
  content:""; position:absolute; left:9px; top:15px; width:8px; height:8px;
  background:radial-gradient(circle,#9fdcff 2px,transparent 3px);
  animation:rainMini 1s linear infinite;
}
@keyframes rainMini{from{transform:translateY(-2px)}to{transform:translateY(4px)}}
</style>
</head>

<body>
<div id="fx"></div>

<div class="app">
  <header>
    <div class="header-left">
  <img class="logo" src="assets/logo-monte-do-pasto.png" alt="Monte do Pasto">

  <div class="now glass">
    <div id="nowIcon" class="icon cloud"></div>
    <div>
      <div id="nowTemp" class="temp">--°C</div>
      <div id="nowDesc" class="desc">---</div>
    </div>
  </div>

  <div id="clock" class="clock clock-inline">--:--</div>
</div>

    <div class="header-mid">
      <div class="group">
        <div class="title">Próx. horas</div>
        <div class="pills" id="hoursPills"></div>
      </div>
      <div class="group">
        <div class="title">Próx. dias</div>
        <div class="pills" id="daysPills"></div>
      </div>
    </div>

    <div class="clock" id="clock">--:--</div>
  </header>

  <main id="kpiGrid"></main>

  <footer>Informação interna · Monte do Pasto</footer>
</div>

<script>
/* =========================================================
   CONFIG
   ========================================================= */
const LAT = 38.219;
const LON = -7.887;

const MAX_VISIBLE_KPIS = 6;       // máx no ecrã
const ROTATE_EVERY_MS  = 15000;   // 15s
const REFRESH_HOURLY_MS = 60*60*1000;

const RAIN_CODES = new Set([51,53,55,61,63,65,80,81,82,95,96,99]);

const WEATHER_URL =
  `https://api.open-meteo.com/v1/forecast?latitude=${LAT}&longitude=${LON}` +
  `&current_weather=true` +
  `&hourly=temperature_2m,precipitation,weathercode,cloudcover,shortwave_radiation` +
  `&daily=temperature_2m_max,temperature_2m_min,weathercode` +
  `&timezone=auto`;

/* =========================================================
   RELÓGIO
   ========================================================= */
function tickClock(){
  clock.textContent = new Intl.DateTimeFormat("pt-PT",{hour:"2-digit",minute:"2-digit"}).format(new Date());
}
tickClock();
setInterval(tickClock, 30000);

/* =========================================================
   HELPERS
   ========================================================= */
const PT_DIAS = ["Dom","Seg","Ter","Qua","Qui","Sex","Sáb"];

function iconClassFrom(code, tempC){
  if (RAIN_CODES.has(code)) return "rain";
  if (code === 0) return "sun";
  return "cloud";
}

function descFrom(code){
  if (RAIN_CODES.has(code)) return "Chuva";
  if (code === 0) return "Sol";
  return "Nublado";
}

function clamp01(x){ return Math.max(0, Math.min(1, x)); }

/* =========================================================
   FX (chuva/sol/nevoeiro) + MOOD
   ========================================================= */
const fx = document.getElementById("fx");

function clearFX(){ fx.innerHTML = ""; }

function addFog(opacity=0.45){
  const f = document.createElement("div");
  f.className = "fog";
  f.style.opacity = String(opacity);
  fx.appendChild(f);
}

function addSun(intensity=0.7){
  const s = document.createElement("div");
  s.className = "sunGlow";
  s.style.opacity = String(0.25 + intensity*0.65);
  fx.appendChild(s);
}

function addRain(count){
  for (let i=0;i<count;i++){
    const d = document.createElement("div");
    d.className = "drop";
    d.style.left = (Math.random()*100) + "%";
    d.style.animationDuration = (0.55 + Math.random()*1.2) + "s";
    d.style.opacity = String(0.22 + Math.random()*0.55);
    d.style.height = (12 + Math.random()*18) + "px";
    fx.appendChild(d);
  }
}

function applyMood({sun, rain, cloud, hour}){
  // mood 0..100
  let mood = 50;
  mood += sun * 40;     // mais sol = mais mood
  mood -= rain * 30;    // mais chuva = mood mais fechado
  mood -= cloud * 20;   // mais nuvens = mood mais fechado
  if (hour < 8 || hour > 18) mood -= 10;
  mood = Math.max(0, Math.min(100, mood));

  // Paletas (A = oliva quando está bom)
  let g1,g2,b1;
  if (mood > 70){
    // dia bom: oliva/amarelado
    g1="#7fae4f"; g2="#4f7f3f"; b1="#6b5a3e";
  } else if (mood > 40){
    // normal
    g1="#6fa98c"; g2="#4f7f63"; b1="#7b6445";
  } else {
    // fechado/terra
    g1="#4f7a63"; g2="#3f5f4f"; b1="#5c472f";
  }

  const r = document.documentElement.style;
  r.setProperty("--g1", g1);
  r.setProperty("--g2", g2);
  r.setProperty("--b1", b1);
}

/* =========================================================
   WEATHER WIDGETS (HEADER)
   ========================================================= */
async function updateWeather(){
  const d = await fetch(WEATHER_URL).then(r=>r.json());
  const cw = d.current_weather;

  const temp = Math.round(cw.temperature);
  const code = cw.weathercode;

  nowTemp.textContent = `${temp}°C`;
  nowDesc.textContent = descFrom(code);
  nowIcon.className = `icon ${iconClassFrom(code,temp)}`;

  // próximas horas (4)
  hoursPills.innerHTML = "";
  for (let i=1;i<=4;i++){
    const t = Math.round(d.hourly.temperature_2m[i]);
    const codeH = d.hourly.weathercode[i];
    const dt = new Date(d.hourly.time[i]);
    const hh = String(dt.getHours()).padStart(2,"0")+"h";
    const ic = iconClassFrom(codeH, t);

    hoursPills.insertAdjacentHTML("beforeend", `
      <div class="pill">
        <div class="icon ${ic}"></div>
        <div>
          <div class="small">${t}°</div>
          <div class="sub">${hh}</div>
        </div>
      </div>
    `);
  }

  // próximos dias (4)
  daysPills.innerHTML = "";
  for (let i=1;i<=4;i++){
    const tmax = Math.round(d.daily.temperature_2m_max[i]);
    const tmin = Math.round(d.daily.temperature_2m_min[i]);
    const codeD = d.daily.weathercode[i];
    const date = new Date(d.daily.time[i]);
    const wd = PT_DIAS[date.getDay()];
    const ic = iconClassFrom(codeD, tmin);

    daysPills.insertAdjacentHTML("beforeend", `
      <div class="pill">
        <div class="icon ${ic}"></div>
        <div>
          <div class="small">${tmax}°/${tmin}°</div>
          <div class="sub">${wd}</div>
        </div>
      </div>
    `);
  }

  // FX + Mood (dados reais)
  clearFX();

  const rain = (d.hourly.precipitation?.[0] ?? 0);           // mm/h
  const cloud = (d.hourly.cloudcover?.[0] ?? 50) / 100;      // 0..1
  const sun = clamp01(((d.hourly.shortwave_radiation?.[0] ?? 0) - 100) / 600); // 0..1

  // baseline de vida (nunca morto)
  addFog(0.35 + cloud*0.35);

  // chuva real -> sempre visível quando weathercode é chuva; densidade escala com mm/h
  if (RAIN_CODES.has(code)){
    const intensity = Math.max(0.15, Math.min(1, rain/4));
    const drops = Math.floor(60 + intensity * 260);
    addRain(drops);
  }

  // sol
  if (code === 0){
    addSun(sun);
  }

  applyMood({
    sun: sun,
    rain: rain,
    cloud: cloud,
    hour: new Date().getHours()
  });
}

/* =========================================================
   KPI ENGINE (ilimitados) + rotação
   ========================================================= */

/**
 * Config de KPIs (ilimitados).
 * Tipos suportados:
 * - rainYTD: calculado automaticamente (L/m²) e comparação com ano anterior
 * - image: mostra imagem externa por URL
 * - number: valor simples
 * - text: texto simples
 */
const KPI_CONFIG = [
  { id:"rainYTD", type:"rainYTD", title:"Chuva acumulada desde 1 de Janeiro" },

  { id:"graf1", type:"image", title:"Gráfico operacional",
    imageUrl:"https://upload.wikimedia.org/wikipedia/commons/3/3a/Precipitation_example_chart.png" },

  { id:"prod", type:"number", title:"Produção diária", value:"1 280", unit:"kg" },

  { id:"tempMed", type:"number", title:"Temperatura média", value:"14", unit:"°C" },

  { id:"consumo", type:"number", title:"Consumo ração", value:"860", unit:"kg" },

  { id:"avisos", type:"text", title:"Avisos", text:"Nenhum alerta ativo" },

  // Mais do que 6 para testar rotação:
  { id:"graf2", type:"image", title:"Gráfico de produção",
    imageUrl:"https://upload.wikimedia.org/wikipedia/commons/6/6f/Graph_example.svg" },

  { id:"nota", type:"text", title:"Nota", text:"Atualiza conteúdos sem mexer no GitHub (URLs externas)." }
];

const kpiGrid = document.getElementById("kpiGrid");
let kpiItems = [];
let page = 0;
let rotateTimer = null;

function kpiCardTemplate({id,title,bodyHtml}){
  return `
    <div class="card kpi-item" data-kpi-id="${id}">
      <h3>${title}</h3>
      ${bodyHtml}
    </div>
  `;
}

function renderKPIs(){
  kpiGrid.innerHTML = "";

  KPI_CONFIG.forEach(k=>{
    if (k.type === "rainYTD"){
      kpiGrid.insertAdjacentHTML("beforeend", kpiCardTemplate({
        id:k.id,
        title:k.title,
        bodyHtml: `
          <div class="kpi" id="rainNow">-- <span>L/m²</span></div>
          <div class="kpi-sub neutral" id="rainDiff">A calcular...</div>
        `
      }));
    }

    if (k.type === "image"){
      // imagem com cache-bust suave (atualiza de hora a hora via refreshImages)
      kpiGrid.insertAdjacentHTML("beforeend", kpiCardTemplate({
        id:k.id,
        title:k.title,
        bodyHtml: `
          <div class="kpi-image">
            <img data-img-url="${k.imageUrl}" alt="${k.title}">
          </div>
        `
      }));
    }

    if (k.type === "number"){
      kpiGrid.insertAdjacentHTML("beforeend", kpiCardTemplate({
        id:k.id,
        title:k.title,
        bodyHtml: `
          <div class="kpi">${k.value} <span>${k.unit ?? ""}</span></div>
        `
      }));
    }

    if (k.type === "text"){
      kpiGrid.insertAdjacentHTML("beforeend", kpiCardTemplate({
        id:k.id,
        title:k.title,
        bodyHtml: `
          <div class="kpi-sub neutral">${k.text}</div>
        `
      }));
    }
  });

  kpiItems = Array.from(document.querySelectorAll(".kpi-item"));
}

/* rotação (máx 6 visíveis) */
function updateKPIVisibility(){
  const start = page * MAX_VISIBLE_KPIS;
  const end = start + MAX_VISIBLE_KPIS;

  kpiItems.forEach((el,i)=>{
    el.classList.toggle("hidden", !(i>=start && i<end));
  });
}

function startRotation(){
  const totalPages = Math.ceil(kpiItems.length / MAX_VISIBLE_KPIS);
  if (rotateTimer) clearInterval(rotateTimer);

  page = 0;
  updateKPIVisibility();

  if (totalPages <= 1) return;

  rotateTimer = setInterval(()=>{
    page = (page + 1) % totalPages;
    updateKPIVisibility();
  }, ROTATE_EVERY_MS);
}

/* =========================================================
   KPI: chuva acumulada YTD (Open-Meteo archive)
   ========================================================= */
async function updateRainYTD(){
  // só corre se existir o KPI no DOM
  const rainNowEl = document.getElementById("rainNow");
  const rainDiffEl = document.getElementById("rainDiff");
  if (!rainNowEl || !rainDiffEl) return;

  const today = new Date();
  const yyyy = today.getFullYear();
  const mm = String(today.getMonth()+1).padStart(2,"0");
  const dd = String(today.getDate()).padStart(2,"0");

  const startThis = `${yyyy}-01-01`;
  const startLast = `${yyyy-1}-01-01`;
  const endToday  = `${yyyy}-${mm}-${dd}`;
  const endLast   = `${yyyy-1}-${mm}-${dd}`;

  const url = (s,e) =>
    `https://archive-api.open-meteo.com/v1/archive?latitude=${LAT}&longitude=${LON}` +
    `&daily=precipitation_sum&start_date=${s}&end_date=${e}&timezone=auto`;

  const [cur, prev] = await Promise.all([
    fetch(url(startThis, endToday)).then(r=>r.json()),
    fetch(url(startLast, endLast)).then(r=>r.json())
  ]);

  const sum = (a)=> (a||[]).reduce((t,v)=>t+(v||0),0);

  const now = sum(cur?.daily?.precipitation_sum);
  const last = sum(prev?.daily?.precipitation_sum);
  const diff = now - last;

  rainNowEl.textContent = `${Math.round(now)} `;

  rainDiffEl.textContent = `${diff>=0?"+":""}${Math.round(diff)} L/m² vs ${yyyy-1}`;
  rainDiffEl.classList.remove("good","bad","neutral");
  rainDiffEl.classList.add(diff>=0 ? "good" : "bad");
}

/* imagens externas: refresh horário com cache-bust */
function refreshExternalImages(){
  const imgs = Array.from(document.querySelectorAll("img[data-img-url]"));
  const ts = Date.now();
  imgs.forEach(img=>{
    const base = img.getAttribute("data-img-url");
    img.src = base + (base.includes("?") ? "&" : "?") + "t=" + ts;
  });
}

/* =========================================================
   SCHEDULER (hora a hora, alinhado à hora certa)
   ========================================================= */
function scheduleHourly(fn){
  // chama já
  fn();

  // alinha à hora
  const now = new Date();
  const msToNextHour =
    (60 - now.getMinutes())*60*1000 - now.getSeconds()*1000 - now.getMilliseconds();

  setTimeout(()=>{
    fn();
    setInterval(fn, REFRESH_HOURLY_MS);
  }, msToNextHour);
}

/* =========================================================
   INIT
   ========================================================= */
async function init(){
  // render KPIs e iniciar rotação
  renderKPIs();
  startRotation();

  // Weather e KPI chuva + imagens externas: hora a hora (alinhado)
  scheduleHourly(()=>{ updateWeather().catch(()=>{}); });
  scheduleHourly(()=>{ updateRainYTD().catch(()=>{}); });
  scheduleHourly(()=>{ refreshExternalImages(); });

  // primeira carga imediata das imagens também (para não esperar pela hora)
  refreshExternalImages();
}
init();
</script>
</body>
</html>
